## 概要

本アプリケーションは、給与計算タスクの管理と処理を支援するために、複数のエージェントを統合したシステムです。  
ユーザーはチャット形式のインターフェースを通じて、タスクの選択、ファイルアップロード、日付入力、タスク実行といった操作を行います。  
各エージェントは、以下のような役割を担っています。

- **ファイル管理（FileAgent）**  
  アップロードされた CSV/Excel ファイルの検証、読み込み、データベースへの保存・再構築を行います。

- **タスク処理（TaskAgent）**  
  個別タスクの処理フロー（ファイルチェック、データ分析、コード生成、テスト実行、結果保存など）を状態機械によって管理し、対話的に実行します。

- **コード生成（CodeAgent）**  
  pandas を用いたデータ処理コードを、LLM を利用して自動生成します。データフレーム情報や追加変数をもとに、ツールチェーン（PythonAstREPLTool や JsonOutputKeyToolsParser）を組み合わせています。

- **チャット対応（ChatAgent）**  
  DataFrame のカラム情報をシステムメッセージとして整形し、ユーザーの質問に対する回答生成を LLM に依頼します。

- **意図解析（IntentAnalyzer）**  
  ユーザーからのテキスト入力を解析し、タスク開始、質問、ファイルアップロード、確認応答、メニュー復帰などの意図を JSON 形式で抽出します。

- **RAG（Retrieval-Augmented Generation）**  
  ルールファイルからドキュメントを取得し、ベクトルストア（FAISS）を利用して関連情報を検索、LLM との連携で補完的回答を生成します。

- **状態管理とルーティング（AgentCollection）**  
  上記各エージェントを統合し、ユーザーの入力に基づいて処理のルーティングや状態遷移（"chat"、"file"、"task"、"date"）を行います。

また、GUI 部分は PyQt6 を利用して構築され、バックグラウンド処理は QThread を活用して UI の応答性を保ちながら各エージェントの処理を実行します。

---

## 目次

- [概要](#概要)
- [目次](#目次)
- [main.py](#mainpy)
  - [目的と概要](#目的と概要)
- [agent\_collection.py](#agent_collectionpy)
  - [目的と概要](#目的と概要-1)
  - [主な機能と内部処理](#主な機能と内部処理)
- [chat\_agent.py](#chat_agentpy)
  - [目的と概要](#目的と概要-2)
  - [詳細な実装内容](#詳細な実装内容)
- [code\_agent.py](#code_agentpy)
  - [目的と概要](#目的と概要-3)
  - [詳細な実装内容](#詳細な実装内容-1)
- [file\_agent.py](#file_agentpy)
  - [目的と概要](#目的と概要-4)
  - [詳細な実装内容](#詳細な実装内容-2)
- [intent\_analyzer.py](#intent_analyzerpy)
  - [目的と概要](#目的と概要-5)
  - [詳細な実装内容](#詳細な実装内容-3)
- [rag\_agent.py](#rag_agentpy)
  - [目的と概要](#目的と概要-6)
  - [詳細な実装内容](#詳細な実装内容-4)
- [task\_agent.py](#task_agentpy)
  - [目的と概要](#目的と概要-7)
  - [詳細な実装内容](#詳細な実装内容-5)
- [utils.py](#utilspy)
  - [目的と概要](#目的と概要-8)
  - [詳細な実装内容](#詳細な実装内容-6)
- [エージェントの状態ループ](#エージェントの状態ループ)
  - [各状態の詳細な役割](#各状態の詳細な役割)
  - [状態ループの流れ](#状態ループの流れ)
- [まとめ](#まとめ)

---

## main.py

### 目的と概要

`main.py` は、アプリケーションのエントリーポイントとして以下の機能を提供します。

- **ロギングと環境設定**  
  - アプリケーション起動時にロギングの設定を行い、実行ログをファイルに出力します。
  - `.env` ファイルから環境変数（アイコンファイルパス、API キー、LLM のモデル名など）を読み込み、各エージェントで使用する設定値をセットアップ。

- **アイコンの読み込みと変換**  
  - 指定されたアイコン画像（PNG形式）を Pillow で読み込み、RGBA 変換後に QImage に変換して GUI 内で AI 発言時のアイコンとして使用します。

- **GUI 構築（PyQt6）**  
  - メインウィンドウ `ChatGPTApp` を作成し、左右に分割されたレイアウトでタスク一覧、ファイル一覧、チャット履歴、チャット表示、入力エリア、ファイルアップロードボタン、新規チャット開始ボタンを配置。
  - 各ウィジェット間のシグナル／スロットの接続を設定し、ユーザー操作（Enter キー、ボタン押下、セルクリックなど）に応じた処理を行います。

- **バックグラウンド処理の管理**  
  - `MgrMessageWorker` クラスを QThread 上で実行し、エージェントからの応答やファイル処理を非同期で実行することで、UI のブロックを防止しています。

- **エージェントとの連携**  
  - `AgentCollection` インスタンスを生成し、各エージェント（TaskAgent、FileAgent、IntentAnalyzer、RAG_Agent など）との初期連携を確立。  
  - ユーザー入力に応じたメッセージ送信やタスク選択処理が、内部のエージェントにシグナルとして渡される設計です。

---

## agent_collection.py

### 目的と概要

`AgentCollection` は、システム全体のエージェント（FileAgent、TaskAgent、IntentAnalyzer、RAG_Agent など）の統括管理クラスです。  
ユーザーからの入力に対して、適切な処理ルートを選択し、状態に応じたエージェント呼び出しを行います。

### 主な機能と内部処理

- **初期化と設定読み込み**  
  - コンストラクタで FileAgent を初期化し、設定ファイル（config.json）の存在を確認。設定が存在しない場合はエラーを発生させることで、ユーザーに注意を促します。  
  - 設定ファイル内の各タスク情報を辞書形式で保持し、TaskAgent のインスタンスを生成（_create_task_agents メソッド）。

- **LLM の初期化**  
  - 環境変数から取得した API キーとモデル名を元に、ChatOpenAI クラスを用いて LLM インスタンス（llm_code、llm_chat、llm_analyzer）を生成。  
  - これにより、コード生成、チャット対話、意図解析で同じ LLM プラットフォームを共有します。

- **IntentAnalyzer の設定**  
  - 初期化後に IntentAnalyzer を作成し、ユーザー入力から意図（IntentType）を抽出するためのプロンプトテンプレートや対話履歴の管理を行います。

- **RAG_Agent の設定**  
  - LLM を用いて、複数のルールファイルからドキュメントをロードし、関連情報検索のためのリトリーバーを作成する RAG_Agent を初期化します。

- **状態管理（State Machine）**  
  - [transitions ライブラリ](https://github.com/pytransitions/transitions) を利用して、内部状態を `"chat"`, `"file"`, `"task"`, `"date"` の 4 状態で管理。  
  - 状態変更に応じて、process_message 内で処理ルート（質問応答、タスク開始、ファイルアップロード、日付入力）を分岐します。

- **ユーザー入力のルーティング**  
  - process_message メソッドで、現在の状態に応じて入力メッセージを処理。  
    - `"chat"` 状態の場合：質問応答（RAG_Agent を用いた回答生成）やタスク開始要求の処理を行う。  
    - `"file"` 状態の場合：ファイルのアップロードとフォーマットチェック、必要ファイルが全て揃った場合は `"date"` へ遷移。  
    - `"date"` 状態の場合：YYYY-MM-DD 形式の日付入力を受け取り、各 TaskAgent に日付情報を伝達。  
    - `"task"` 状態の場合：TaskAgent を介して、各タスクの実行プロセス（ファイルチェック、分析、コード生成など）を実行。
    
- **タスク・ファイル管理メソッド**  
  - get_task_list, get_task, reset_all_task_agents などのメソッドを通じて、タスクやファイルの情報の取得、更新、削除を行います。  
  - process_files メソッドでは、必要なファイルの一覧を収集し、ユーザーにアップロードを促すメッセージを生成します。

---

## chat_agent.py

### 目的と概要

`ChatAgent` は、チャットシナリオにおいて pandas DataFrame の情報（主にカラム名など）をシステムメッセージとして組み立て、LLM へ入力するエージェントです。  
ユーザーの質問に対して、データ構造を含んだ回答を生成させるための補助的な役割を担います。

### 詳細な実装内容

- **データフレーム情報の追加**  
  - add_dataframe メソッドで、DataFrame のカラム一覧を抽出し、タプル (DataFrame 名, カラムリストの文字列) を内部リスト df_column_list に追加。  
  - この情報は、LLM へのシステムメッセージに埋め込むために用いられます。

- **システムメッセージの更新 (_update_chain)**  
  - 登録済みの DataFrame 情報を、事前定義された CSS やコードブロック形式（バッククオートを利用）にフォーマットし、  
    「以下の pandas データフレームに関する情報があります：」というプロンプトとして整形。  
  - これにより、ユーザーの質問に対して、LLM が利用可能なデータ構造情報を参照しながら回答を生成可能になります。

- **対話実行 (execute)**  
  - システムメッセージとユーザーの質問（HumanMessage）を LLM に渡し、生成された回答（AIMessage の content）を返す。  
  - 回答は、必要に応じて HTML 表示などもサポートしており、ユーザーがコピーや選択を行えるように工夫されています。

---

## code_agent.py

### 目的と概要

`CodeAgent` は、pandas DataFrame を扱う Python コードを自動生成するエージェントです。  
ユーザーのリクエストに対して、データフレームの情報と追加変数を元に、LLM によるコード生成チェーンを構築します。

### 詳細な実装内容

- **データフレームの登録と情報取得**  
  - add_dataframe メソッドでは、DataFrame を内部辞書 df_dict に登録し、df.info() の出力（文字列）を df_info_list に保存。  
  - これにより、各 DataFrame の構造やデータ型、欠損値の状況などがシステムプロンプトに反映されます。

- **チェーンの更新 (_update_chain)**  
  - 登録された DataFrame 情報を、コードブロック形式に整形。例えば、  
    ```
    df_name.columns
    >>> column1, column2, ...
    ```  
    という形式にすることで、LLM に対してデータの前提条件を明示。
  - PythonAstREPLTool をツールとしてバインドし、LLM にコード実行環境を提供するための設定を行う。  
  - また、JsonOutputKeyToolsParser を用いることで、LLM の出力から純粋な Python コードのみを抽出します。

- **コード生成 (execute)**  
  - ユーザーの質問を入力とし、更新済みのチェーンを実行。  
  - 生成されたコードが "import pandas as pd" を含むかどうかをチェックし、含まれていなければ自動補完。  
  - 生成されたコードは、後に TaskAgent で一時ファイル経由で実行可能なモジュールとして読み込まれ、関数として利用されます。

---

## file_agent.py

### 目的と概要

`FileAgent` は、CSV および Excel ファイルの読み込み、保存、検証、削除を担当します。  
SQLAlchemy を用いて、SQLite データベース上にファイルのメタデータおよびファイル内データを永続化します。

### 詳細な実装内容

- **ORM 定義とカスタム型**  
  - DataFile クラス：ファイル名、パス、定義、オリジナルファイル名、ファイルタイプ、アップロード日時、カラム情報（JSONEncodedDict を利用）、行数、関連タスク、出力フラグを管理。  
  - DataTable クラス：ファイル内各行のデータを JSONEncodedDict 型で保存し、レコードごとの作成日時を記録。
  - JSONEncodedDict は、Python の辞書を JSON 文字列に変換して DB に格納するための TypeDecorator。

- **ファイル保存 (store_csv_file)**  
  - pandas DataFrame をチャンク単位（例：chunk_size=1000）で DB に保存。  
  - ファイルのカラム情報やデータ型の情報を保持し、後に再構築する際にオリジナルのカラム順序を復元。

- **ファイル読み込みと再構築**  
  - load_data_as_df や load_data_as_df_by_definition により、保存済みのファイル情報から DataFrame を再生成。  
  - オリジナルのカラム順を、保存された column_info から取得して正確に復元。

- **ファイル照合 (check_file_identity)**  
  - アップロードされたファイルと、設定情報内の各タスクで定義された「必要なファイル」との照合を実施。  
  - サンプルファイル（例：task_sample.csv）と比較し、列名の一致や不足を確認することで、どのタスクのファイルであるかを推定。

- **ファイル削除**  
  - delete_file, delete_all_files で、指定されたファイルまたはすべてのファイルデータを DB から削除。  
  - 失敗時はロールバックし、エラーログを記録する設計。

- **Excel 特有の処理**  
  - _get_header_index では、シート内に「社員番号」や「スタッフコード」といったキーワードが含まれる行をヘッダー行として自動検出。  
  - _read_excel で不要な "Unnamed" や "NaN" 系の列を除去し、適切な型変換を行う。

---

## intent_analyzer.py

### 目的と概要

`IntentAnalyzer` は、ユーザーからの自然言語入力を解析し、どの意図（タスク開始、質問、ファイルアップロード、確認応答、メニュー復帰など）が込められているかを抽出します。  
LLM を利用して、対話の文脈、ユーザー入力、利用可能なタスク情報を含むプロンプトを生成し、JSON 形式の応答を得る設計です。

### 詳細な実装内容

- **プロンプトテンプレート**  
  - ユーザー入力前の対話履歴（最新3件程度）と、利用可能なタスク一覧（タスク名のみ）をテンプレートに埋め込み、  
    「以下の形式で JSON を返してください」といった具体的な指示を記述。  
  - 例として、  
    ```json
    {"intent": "task_start", "task_name": "task1 | task2 | ..."}
    ```  
    のような形式を求める。

- **LLM 呼び出しと解析**  
  - LLM に対してプロンプトを渡し、返されたテキストから正規表現を用いて JSON 部分を抽出し、json.loads でパース。  
  - 解析に失敗した場合は、デフォルトで `"unknown"` を返すように設計。

- **メモリプールの利用**  
  - 最近の対話履歴を memory_pool に蓄積し、プロンプト生成時にコンテキストとして利用。  
  - これにより、ユーザーの連続した入力の意図をより正確に把握できます。

---

## rag_agent.py

### 目的と概要

`RAG_Agent` は、Retrieval-Augmented Generation (RAG) の手法を用いて、複数のルールファイル（Markdown）から関連情報を抽出し、LLM で回答を生成するエージェントです。

### 詳細な実装内容

- **ルールファイルの探索と読み込み**  
  - _get_all_file_paths で、環境変数で指定されたベースパス内の "rule" フォルダを探索し、対象となる Markdown ファイルのパスを抽出。  
  - 特定のキーワード（例："説明用" や "sample"）が含まれるファイルは除外し、純粋なルール定義のみを対象とする。

- **テキスト分割とベクトルストア構築**  
  - 各ルールファイルの内容を TextLoader で読み込み、RecursiveCharacterTextSplitter により、チャンクサイズ（例：1000文字、200文字の重複）に分割。  
  - 分割されたドキュメント群を FAISS ベクトルストアによりベクトル化し、類似度検索が可能なリトリーバーを作成。

- **RAG チェーンの構築**  
  - リトリーバーで検索されたテキスト（format_docs で連結）をコンテキストとして、LLM に質問を投げるチェーンを構築。  
  - チェーンは、リトリーバー、プロンプト、LLM の実行、出力パーサー（StrOutputParser）を連結したパイプラインとして実装。

- **実行と応答生成**  
  - execute メソッドでは、質問文に特定のサフィックス（例："(タスクを紹介する場合必ず定義を含め)"）を付加して、RAG チェーンを実行し、LLM の出力から最終的な回答を抽出して返す。

---

## task_agent.py

### 目的と概要

`TaskAgent` は、個別の給与計算タスクの処理全体（ファイルチェック、データ分析、コード生成、テスト実行、結果保存など）を担当します。  
内部で状態機械（transitions ライブラリ）を用いて、各処理ステップを明確に区分し、対話型の処理フローを実現します。

### 詳細な実装内容

- **タスク設定の読み込み**  
  - コンストラクタで、タスク名、概要、必要ファイル（必須とオプション）、次タスク情報、ルールファイル名などを設定ファイルから取得。  
  - 各タスク毎に CodeAgent、ChatAgent を初期化し、タスク固有のプロンプトや関数名（例："data_processing_{idx}"）を設定。

- **状態機械の構築**  
  - 状態リストは、`prepare`, `file`, `analysis`, `date`, `process`, `test`, `work`, `revise`, `continue`, `over` の各状態から成り、  
    初期状態は `"prepare"` となる。  
  - 拡張状態として FileState を実装し、ファイル処理時の現在のファイルインデックスの管理を行います。

- **各ステップの処理メソッド**  
  - **process_prepare**：タスク開始の確認（Yes/No など）を受け、次のステップへ遷移。  
  - **_process_file_message**：アップロードされたファイルを読み込み、FileAgent の機能を通じて DataFrame に変換し、CodeAgent と ChatAgent に追加。  
  - **process_analysis**：ファイル内のデータ構造や列名の関係を ChatAgent を用いて分析し、ルールファイルの内容（prompt_content）を読み込む。  
  - **process_generation**：CodeAgent を用いて、ルールに基づいた Python 関数コードを生成し、生成した関数を一時ファイル経由でモジュールとしてロード。  
  - **process_test**：生成された関数に対し、特定のスタッフコードでテスト実行を行い、テスト結果を表示。  
  - **process_work / process_all_staffcodes**：すべてのスタッフコードに対して生成関数を適用し、複数の DataFrame を連結して最終結果を得る。  
  - **_try_again**：エラー発生時の再試行処理を実施。失敗時にはエラー詳細を返し、状態を "over" に変更する。

- **データ前処理 (_process_df)**  
  - DataFrame 内に「スタッフコード」または「社員番号」が存在するかを検証し、どちらかを統一的な「スタッフコード」列に変換。  
  - 数値型の場合は整数に変換した後、文字列型へキャストするなどの処理を実施。

- **結果保存**  
  - save_result_to_csv により、処理結果を CSV として保存。  
  - 次タスクへのファイルの受け渡しが必要な場合は、FileAgent を通じて DB にも登録し、保存パスを TaskAgent 内で保持。

---

## utils.py

### 目的と概要

`utils.py` は、文字列の類似度計算など、複数のモジュールで共通して利用される汎用関数を提供します。

### 詳細な実装内容

- **similarity_ratio(word1, word2)**  
  - Python の difflib.SequenceMatcher を利用して、2 つの文字列間の類似度を 0～1 の範囲で計算。

- **return_most_similiar_word(input_word, word_list, threshold=0.2)**  
  - 入力文字列と候補リスト内の各単語との類似度を計算し、最も高いスコアを持つ単語を返す。  
  - 類似度が指定の threshold 未満の場合は None を返すことで、あまり一致しない候補を除外する。

---

## エージェントの状態ループ

本システムでは、ユーザーの入力ごとに状態のチェックと必要なエージェントの呼び出しを行いながら、処理が循環するループ構造を実現しています。

### 各状態の詳細な役割

- **chat 状態**  
  - 基本的な対話モード。ユーザーはここでタスク開始要求、質問、メニュー復帰の指示などを行う。  
  - IntentAnalyzer により解析された意図に基づき、必要な場合はタスク開始（workflow へのタスク追加）やファイルアップロード（状態の "file" への遷移）に切り替えます。

- **file 状態**  
  - ファイルアップロードに特化した状態。  
  - FileAgent を通じて、ファイルのパス、拡張子、フォーマットチェック、サンプルファイルとの照合を実施。  
  - 必須ファイルが全て揃うと、次に日付入力（"date" 状態）へ遷移し、ファイルアップロードが完了した旨のメッセージを返します。

- **date 状態**  
  - タスク処理開始に必要な日付（YYYY-MM-DD 形式）の入力を受け付け、正規表現による妥当性チェックを実施。  
  - 有効な日付が入力された場合、各 TaskAgent に対して日付情報が伝達され、タスク実行の準備が整います。

- **task 状態**  
  - 各 TaskAgent が実際のタスク処理（ファイルチェック、データ分析、コード生成、テスト実行、結果保存など）を実行する状態。  
  - ユーザーからの確認応答や入力に応じ、各ステップを進行。タスクの進捗に合わせて状態遷移（例：prepare → file → analysis → process → test → work → revise → continue → over）が行われる。  
  - fast mode の場合、状態遷移が簡略化され、処理ループを高速に回す設計となっています。

### 状態ループの流れ

1. **初期状態：chat**  
   - システム起動時、または新規チャット開始時に `chat` 状態となり、ユーザー入力待ちとなる。

2. **入力受付と意図解析**  
   - ユーザーが入力すると、process_message() で IntentAnalyzer が呼ばれ、入力文から意図（task_start, file_upload, question, confirmation, return_to_menu, unknown）が抽出される。

3. **状態に応じた処理分岐**  
   - 例えば、タスク開始の要求であれば、対象タスク名が抽出され workflow に追加され、状態が `"file"` へと切り替わる。  
   - ファイルアップロードの場合、ファイルの存在とフォーマットが確認され、必要なファイルがすべてアップロードされると `"date"` 状態へ遷移。  
   - 日付が有効と判断されると、タスク処理の詳細（`TaskAgent` による実行）が `"task"` 状態で開始される。

4. **タスク実行と確認応答**  
   - TaskAgent 内で、各処理ステップ（analysis, process, test, work, など）が対話形式で実行され、ユーザー確認や追加入力があればその都度次ステップへの遷移が行われる。  
   - 途中で「No」などの否定応答があれば、early exit や再試行、あるいはメニュー復帰などの分岐が行われる。

5. **ループの継続**  
   - タスクが完了した場合（状態が `"over"` となった場合）、AgentCollection は再び `chat` 状態に戻り、別のタスクの選択や新たなファイルアップロードが可能になる。

---

## まとめ

この CODE_DOCUMENTATION では、システム全体の概要、各モジュールの目的・内部処理、使用している外部ライブラリとの連携、状態管理の詳細な設計と、エージェントの状態ループの流れについて説明しました。  
具体的には以下の点が重要です。

- **ユーザー対話とエージェント連携**  
  ユーザーはチャット形式の UI を通じて、タスク開始、ファイルアップロード、日付入力、タスク実行などを直感的に行うことができ、各エージェントが協調してこれらの操作を実現します。

- **状態管理による柔軟な処理フロー**  
  AgentCollection の状態機械により、"chat"、"file"、"date"、"task" の各状態間で動的な遷移が行われ、ユーザーの入力内容に応じた最適な処理ルートが選択されます。

- **各エージェントの専門的役割**  
  - FileAgent はファイル管理全般、  
  - TaskAgent は個別タスクの実行フロー、  
  - CodeAgent はコード生成、  
  - ChatAgent は対話支援、  
  - IntentAnalyzer は意図解析、  
  - RAG_Agent は補完的な回答生成を担当し、  
  これらが統合されることで、給与計算タスクに関する複雑な処理が自動化されています。

この詳細なドキュメントは、今後の拡張や保守、デバッグの際のリファレンスとして役立つことを目的としています。
