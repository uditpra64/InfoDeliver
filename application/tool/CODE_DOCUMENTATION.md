# CODE_DOCUMENTATION.md

## 概要

本モジュールは、2つのCSVファイル（正解CSVと出力CSV）の構造およびデータ内容を比較するためのツールです。

- **ログ出力**: カスタムログフォーマッタを使用して、処理状況や差異をコンソールおよびファイルに出力します。
- **環境設定**: `.env` ファイルからCSVファイルのパスを取得します。
- **比較処理**: pandas を用いてCSVファイルを読み込み、カラム構造・行数・各セルの値について比較を行います。

## 目次

1. [依存ライブラリとインポート](#依存ライブラリとインポート)
2. [カスタムログフォーマッタ (CustomFormatter)](#カスタムログフォーマッタ-customformatter)
3. [ロガーのセットアップ (setup_logger)](#ロガーのセットアップ-setup_logger)
4. [CSVComparator クラス](#csvcomparator-クラス)
   - [コンストラクタ (__init__)](#コンストラクタ-init)
   - [CSVファイルの読み込み (load_csv_files)](#csvファイルの読み込み-load_csv_files)
   - [構造の比較 (compare_structure)](#構造の比較-compare_structure)
   - [データ値の比較 (compare_data)](#データ値の比較-compare_data)
   - [全体比較の実行 (compare_csvs)](#全体比較の実行-compare_csvs)
5. [メイン実行ブロック](#メイン実行ブロック)
6. [まとめ](#まとめ)

## 依存ライブラリとインポート

- **標準ライブラリ**

  - `logging`, `os`, `datetime`→ ログの記録、ファイルパス操作、タイムスタンプの生成に使用。
  - `typing` (Dict, List, Tuple)
    → 型ヒントを提供し、コードの可読性と保守性を向上。
- **外部ライブラリ**

  - `pandas`→ CSVファイルを DataFrame として読み込み、データ比較を行うために利用。
  - `dotenv`
    → `.env` ファイルから環境変数をロードして、CSVファイルのパスを取得する。

## カスタムログフォーマッタ (CustomFormatter)

`CustomFormatter` クラスは、`logging.Formatter` を継承し、ログレベルごとに異なる出力形式を定義しています。

- **属性**:

  - `header_format`: ヘッダー出力用のフォーマット（CRITICALレベルで使用）。
  - `info_format`: INFOレベルのログ用。先頭に空白2個でインデント。
  - `warning_format`: WARNINGレベルのログ用。警告記号 "⚠" を先頭に付与。
  - `error_format`: ERRORレベルのログ用。エラー記号 "❌" を先頭に付与。
  - `success_format`: 成功時用のフォーマット（ここでは定義のみで、明示的なレベル割当はなし）。
- **メソッド**:

  - `format(record)`: ログレベルに応じて内部のフォーマット文字列 (`_style._fmt`) を切り替え、ログメッセージを整形した上で元のフォーマットに復元して返す。

## ロガーのセットアップ (setup_logger)

`setup_logger()` 関数は、以下の処理を行います：

1. 名前 `"CSVComparator"` のロガーを作成し、ログレベルを INFO に設定。
2. 現在の日時を用いて、ログファイル名（例: `csv_comparison_20230315_142530.log`）を生成し、ファイルハンドラを作成。
   - ファイルハンドラは UTF-8 エンコーディングでログを出力し、`CustomFormatter` を適用。
3. コンソール出力用のストリームハンドラを作成し、同様に `CustomFormatter` を適用。
4. 両方のハンドラをロガーに追加し、設定済みのロガーを返す。

## CSVComparator クラス

CSVComparator クラスは、CSVファイルの読み込みと比較処理の全体を管理します。

### コンストラクタ (__init__)

- **処理内容**:
  - `setup_logger()` を呼び出し、ロガーを初期化。
  - `load_dotenv()` により、`.env` ファイルから環境変数をロード。
  - 環境変数 `"CORRECT_CSV_PATH"` と `"OUTPUT_CSV_PATH"` からそれぞれ正解CSVと出力CSVのパスを取得。
    - どちらかが未設定の場合、`ValueError` を発生させる。

### CSVファイルの読み込み (load_csv_files)

- **機能**:
  - 正解CSVと出力CSVのファイルを、それぞれ pandas の `read_csv` を用いて DataFrame として読み込みます。
  - 読み込み成功後、各CSVの行数およびカラム数をログに記録。
  - 例外発生時は、エラーログを出力し例外を再送出。

### 構造の比較 (compare_structure)

- **目的**:CSVファイル同士のカラム構造および行数の一致を確認します。
- **処理内容**:

  - 両DataFrameのカラム名リストを取得し、完全一致するかチェック。
    - 一致しない場合は、どちらにのみ存在するカラムがあるか詳細をログに記録。
  - 行数についても、両DataFrameの長さが一致しているかを比較し、結果をログ出力。
  - 結果は辞書形式で返却し、`columns_match`、`row_count_match`、および詳細な差異情報を含む `differences` キーが含まれる。

### データ値の比較 (compare_data)

- **目的**:両CSVの共通カラムに対して、各セルの値を比較し、差異がある箇所を特定します。
- **処理内容**:

  - 両DataFrameの共通カラムを抽出。共通カラムが存在しない場合は警告を出して処理を終了。
  - 各カラムごとに、最小行数分ループして各行の値を比較：
    - **数値型の場合**: NaNでない値同士で、絶対誤差が1e-10を超える場合に差異と判断。
    - **その他のデータ型の場合**: 完全一致か否かで差異を判断。
  - 差異があった場合、その行番号（1始まり）、カラム名、正解値および出力値を辞書形式でリストに追加。
  - 各カラムごとに、差異件数をログ出力し、総差異件数が0件でなければ詳細な差異内容もログに記録。
  - 差異リストを返却。

### 全体比較の実行 (compare_csvs)

- **目的**:CSVファイル全体の読み込み、構造比較、データ値比較を統合的に実施し、最終結果をまとめます。
- **処理内容**:

  1. ヘッダー部分として比較レポートの開始をログ出力。
  2. `load_csv_files()` によりCSVファイルを読み込み。
  3. `compare_structure()` で構造の一致を確認し、結果を取得。
  4. `compare_data()` でデータ値の差異を特定し、結果を取得。
  5. 上記結果を統合して、全体が完全一致しているか（構造とデータの両方が一致しているか）を判定。
     - 判定結果は、`is_identical` キーに Boolean 値として格納。
  6. 最終結果をログに出力し、結果の辞書を返却。

## メイン実行ブロック

- **main 関数**:

  - `CSVComparator` のインスタンスを生成し、`compare_csvs()` を実行してCSV比較処理を開始。
  - 例外発生時には、エラーログを出力。
- **エントリポイント**:

  - `if __name__ == "__main__":` ブロック内で `main()` を呼び出し、スクリプトとして実行された場合に比較処理が実行される。

## まとめ

本ソースコードは、環境変数で指定された2つのCSVファイルの構造および内容を比較し、相違点を詳細にログ出力するツールです。

- **カスタムログ**: ログフォーマッタにより、処理状況やエラー、警告、成功情報を見やすく出力します。
- **CSV比較処理**: pandas を活用して効率的にCSVファイルを読み込み、構造およびセル単位での比較を行い、ユーザーにわかりやすいレポートを生成します。
- **柔軟な設定**: `.env` ファイルによる設定により、ファイルパスの変更が容易です。

このドキュメントは、コードの理解、保守、及び将来的な拡張に役立つことを目的としています。
